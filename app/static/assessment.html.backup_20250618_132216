<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Maturit√† Digitale - Sistema Completo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .btn { 
            background: #4f46e5; 
            color: white; 
            padding: 15px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px 5px;
            transition: all 0.3s;
        }
        .btn:hover { background: #3730a3; transform: translateY(-2px); }
        .btn.success { background: #10b981; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .hidden { display: none; }
        .question-group { 
            margin-bottom: 25px; 
            padding: 20px; 
            border: 1px solid #e5e7eb; 
            border-radius: 8px; 
            background: #f9fafb;
        }
        .question-group h4 { 
            color: #1f2937; 
            margin-bottom: 15px; 
            font-size: 16px;
        }
        .checkbox-group { margin-bottom: 10px; }
        .checkbox-group label { 
            display: flex; 
            align-items: center; 
            margin-bottom: 8px; 
            cursor: pointer;
        }
        .checkbox-group input[type="checkbox"] { 
            margin-right: 10px; 
            transform: scale(1.2);
        }
        .progress-section { 
            background: #e5e7eb; 
            height: 8px; 
            border-radius: 4px; 
            margin: 20px 0;
        }
        .progress-bar { 
            background: #4f46e5; 
            height: 100%; 
            border-radius: 4px; 
            transition: width 0.5s;
        }
        .section-header { 
            background: linear-gradient(135deg, #4f46e5, #7c3aed); 
            color: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px;
        }
        .ai-suggestions { 
            background: #f0f9ff; 
            border-left: 4px solid #0ea5e9; 
            padding: 20px; 
            margin: 20px 0;
            border-radius: 8px;
        }
        .ai-suggestions h4 { color: #0369a1; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Assessment Maturit√† Digitale</h1>
            <p>Framework UE completo + AI + PDF + Email</p>
        </div>

        <!-- Selezione Azienda -->
        <div class="card" id="companySelection">
            <h3>üè¢ Seleziona o Inserisci Azienda</h3>
            <input type="text" id="companySearch" placeholder="Cerca azienda esistente..." style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px;">
            <div id="searchResults" style="display: none;"></div>
            
            <div id="companyInfo" class="hidden" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p><strong>Azienda:</strong> <span id="selectedCompany"></span></p>
                <p><strong>Settore:</strong> <span id="selectedSector"></span></p>
            </div>
            
            <h4>üìù Inserisci Nuova Azienda:</h4>
            <input type="text" id="newCompanyName" placeholder="Nome azienda" style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px;">
            <select id="sectorSelect" style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px;">
                <option value="">-- Seleziona Settore --</option>
                <option value="Technology">Technology</option>
                <option value="Manufacturing">Manufacturing</option>
                <option value="Services">Services</option>
                <option value="Retail">Retail</option>
                <option value="Finance">Finance</option>
            </select>
            
            <button class="btn" onclick="startAssessment()">üöÄ Inizia Assessment</button>
        </div>

        <!-- Assessment Area per Area -->
        <div class="card hidden" id="assessmentPanel">
            <div class="section-header">
                <h3 id="sectionTitle">üìä Caricamento Assessment...</h3>
                <p id="sectionDescription">Preparazione domande...</p>
            </div>
            
            <div class="progress-section">
                <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
            </div>
            
            <div id="questionsContainer"></div>
            
            <div id="navigationButtons" class="hidden">
                <button class="btn" id="prevBtn" onclick="previousSection()" disabled>‚Üê Sezione Precedente</button>
                <button class="btn" id="nextBtn" onclick="nextSection()">Sezione Successiva ‚Üí</button>
                <button class="btn success hidden" id="submitBtn" onclick="submitAssessment()">‚úÖ Completa Assessment</button>
            </div>
        </div>

        <!-- Risultati + AI Suggestions -->
        <div class="card hidden" id="resultsPanel">
            <h3>üìä Risultati Assessment</h3>
            <div id="resultsContent"></div>
            
            <div class="ai-suggestions" id="aiSuggestions">
                <h4>ü§ñ Suggerimenti AI Personalizzati</h4>
                <div id="aiContent">Generazione suggerimenti in corso...</div>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn success" onclick="generatePDF()">üìÑ Genera PDF</button>
                <button class="btn success" onclick="sendEmail()">üìß Invia Email</button>
                <button class="btn" onclick="newAssessment()">üîÑ Nuovo Assessment</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentCompany = null;
        let companiesData = [];
        let selectedCompanyData = null;
        let assessmentSections = [];
        let currentSectionIndex = 0;
        let responses = {};

        // Companies search functionality
        async function loadCompanies() {
            try {
                const response = await fetch('https://intelligence.enduser-digital.com/api/companies');
                const data = await response.json();
                companiesData = data.companies || [];
                console.log('‚úÖ Loaded', companiesData.length, 'companies');
            } catch (error) {
                console.error('Error loading companies:', error);
            }
        }

        function setupCompanySearch() {
            const searchInput = document.getElementById('companySearch');
            const resultsDiv = document.getElementById('searchResults');

            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                const filtered = companiesData.filter(comp => 
                    comp.name.toLowerCase().includes(query)
                ).slice(0, 10);

                if (filtered.length > 0) {
                    resultsDiv.innerHTML = filtered.map(comp => 
                        `<div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; background: white;" onclick="selectCompany(${comp.id}, '${comp.name}', '${comp.sector}')">${comp.name} - ${comp.sector}</div>`
                    ).join('');
                    resultsDiv.style.display = 'block';
                    resultsDiv.style.position = 'absolute';
                    resultsDiv.style.background = 'white';
                    resultsDiv.style.border = '1px solid #ddd';
                    resultsDiv.style.borderRadius = '6px';
                    resultsDiv.style.width = searchInput.offsetWidth + 'px';
                    resultsDiv.style.maxHeight = '200px';
                    resultsDiv.style.overflowY = 'auto';
                    resultsDiv.style.zIndex = '1000';
                } else {
                    resultsDiv.style.display = 'none';
                }
            });
        }

        function selectCompany(id, name, sector) {
            selectedCompanyData = { id, name, sector };
            
            document.getElementById('companySearch').value = name;
            document.getElementById('searchResults').style.display = 'none';
            
            document.getElementById('selectedCompany').textContent = name;
            document.getElementById('selectedSector').textContent = sector;
            document.getElementById('companyInfo').classList.remove('hidden');
            
            document.getElementById('newCompanyName').value = '';
            document.getElementById('sectorSelect').value = '';
        }

        // Assessment functionality
        async function startAssessment() {
            let companyData;
            
            if (selectedCompanyData) {
                companyData = selectedCompanyData;
            } else {
                const companyName = document.getElementById('newCompanyName').value;
                const sector = document.getElementById('sectorSelect').value;
                
                if (!companyName) {
                    alert('‚ö†Ô∏è Seleziona un\'azienda esistente o inserisci una nuova azienda');
                    return;
                }
                
                companyData = { id: null, name: companyName, sector: sector || 'Technology' };
            }
            
            currentCompany = companyData;
            console.log('üöÄ Starting assessment for:', currentCompany);
            
            document.getElementById('companySelection').classList.add('hidden');
            document.getElementById('assessmentPanel').classList.remove('hidden');
            
            await loadAssessmentQuestions();
        }

        async function loadAssessmentQuestions() {
            try {
                document.getElementById('sectionTitle').textContent = 'üìä Caricamento Domande...';
                document.getElementById('progressBar').style.width = '20%';
                
                const response = await fetch('https://intelligence.enduser-digital.com/api/assessment/questions');
                const data = await response.json();
                assessmentSections = data.sections || [];
                
                console.log('‚úÖ Loaded', assessmentSections.length, 'assessment sections');
                
                if (assessmentSections.length > 0) {
                    currentSectionIndex = 0;
                    document.getElementById('progressBar').style.width = '50%';
                    showCurrentSection();
                    document.getElementById('progressBar').style.width = '100%';
                } else {
                    document.getElementById('sectionTitle').textContent = '‚ùå Errore Caricamento Domande';
                }
                
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('sectionTitle').textContent = '‚ùå Errore Caricamento';
            }
        }

        function showCurrentSection() {
            if (currentSectionIndex >= assessmentSections.length) return;
            
            const section = assessmentSections[currentSectionIndex];
            
            document.getElementById('sectionTitle').textContent = section.title;
            document.getElementById('sectionDescription').textContent = section.description;
            
            // Render questions for current section
            let questionsHTML = '<div class="section-questions">';
            
            section.questions.forEach((question, qIndex) => {
                const questionId = `${section.id}_${question.id}`;
                questionsHTML += `
                    <div class="question-group">
                        <h4>${question.text}</h4>
                        <div class="checkbox-group">
                `;
                
                question.options && question.options && question.options.forEach(option => {
                    const checked = responses[questionId] && responses[questionId].includes(option.value) ? 'checked' : '';
                    questionsHTML += `
                        <label>
                            <input type="checkbox" name="${questionId}" value="${option.value}" 
                                   onchange="updateResponse('${questionId}', '${option.value}', this.checked)" ${checked}>
                            ${option.label}
                        </label>
                    `;
                });
                
                questionsHTML += `
                        </div>
                    </div>
                `;
            });
            
            questionsHTML += '</div>';
            
            document.getElementById('questionsContainer').innerHTML = questionsHTML;
            document.getElementById('navigationButtons').classList.remove('hidden');
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = currentSectionIndex === 0;
            
            if (currentSectionIndex === assessmentSections.length - 1) {
                document.getElementById('nextBtn').classList.add('hidden');
                document.getElementById('submitBtn').classList.remove('hidden');
            } else {
                document.getElementById('nextBtn').classList.remove('hidden');
                document.getElementById('submitBtn').classList.add('hidden');
            }
            
            // Update progress
            const progress = ((currentSectionIndex + 1) / assessmentSections.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function updateResponse(questionId, value, checked) {
            if (!responses[questionId]) {
                responses[questionId] = [];
            }
            
            if (checked) {
                if (!responses[questionId].includes(value)) {
                    responses[questionId].push(value);
                }
            } else {
                responses[questionId] = responses[questionId].filter(v => v !== value);
            }
        }

        function previousSection() {
            if (currentSectionIndex > 0) {
                currentSectionIndex--;
                showCurrentSection();
            }
        }

        function nextSection() {
            if (currentSectionIndex < assessmentSections.length - 1) {
                currentSectionIndex++;
                showCurrentSection();
            }
        }

        async function submitAssessment() {
            document.getElementById('sectionTitle').textContent = 'üìä Elaborazione Risultati...';
            document.getElementById('questionsContainer').innerHTML = '<p style="text-align: center; padding: 40px;">üîÑ Calcolo punteggi e generazione suggerimenti AI...</p>';
            
            try {
                const response = await fetch('https://intelligence.enduser-digital.com/api/assessment/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_id: currentCompany?.id,
                        company_name: currentCompany?.name,
                        responses: responses
                    })
                });
                
                const result = await response.json();
                console.log('‚úÖ Assessment submitted:', result);
                
                // Generate AI suggestions
                await generateAISuggestions(result);
                
                // Show results
                showResults(result);
                
            } catch (error) {
                console.error('Error submitting assessment:', error);
                alert('‚ùå Errore invio assessment: ' + error.message);
            }
        }

                async function generateAISuggestions(assessmentResult) {
            const overallScore = assessmentResult.overall_score;
            const strategyScore = assessmentResult.strategy_score;
            const readinessScore = assessmentResult.readiness_score;
            const companyName = currentCompany?.name || 'Azienda';
            
            // Funzione per generare roadmap innovazione
            function getInnovationRoadmap(overall) {
                if (overall > 80) {
                    return [
                        "ü§ñ **Artificial Intelligence Avanzata**: Implementare sistemi di ML per predictive analytics e automazione decisionale",
                        "üîó **Blockchain & Web3**: Esplorare smart contracts per supply chain e trasparenza transazionale", 
                        "üåê **Edge Computing**: Distribuire elaborazione vicino ai dati per latenza ultra-bassa",
                        "ü¶æ **Automazione Intelligente**: RPA integrato con AI per processi complessi end-to-end",
                        "üéØ **Digital Twin**: Modellazione digitale per simulazione e ottimizzazione operativa",
                        "üìä **Advanced Analytics**: Implementare data lakes e real-time business intelligence"
                    ];
                } else if (overall > 60) {
                    return [
                        "‚òÅÔ∏è **Cloud-First Architecture**: Migrazione completa su architetture cloud native",
                        "ü§ñ **AI Assistants**: Chatbot e automazione processi con intelligenza artificiale",
                        "üì± **API Economy**: Sviluppare ecosistemi integrati tramite API management",
                        "üîê **Cybersecurity Avanzata**: Zero-trust architecture e monitoring predittivo",
                        "üìà **Business Intelligence**: Dashboard real-time e analisi predittive",
                        "üîÑ **DevOps Culture**: CI/CD pipelines e infrastructure as code"
                    ];
                } else if (overall > 40) {
                    return [
                        "‚òÅÔ∏è **Cloud Migration**: Trasferimento graduale su piattaforme cloud ibride",
                        "üìä **Data Analytics Foundation**: Implementare data warehouse e KPI tracking",
                        "ü§ù **Digital Collaboration**: Piattaforme integrate per remote working",
                        "üì± **Mobile-First Solutions**: App native per processi business critici",
                        "üîí **Security Baseline**: Implementare protocolli di sicurezza moderni",
                        "üîÑ **Process Automation**: Automatizzare task ripetitivi con soluzioni low-code"
                    ];
                } else {
                    return [
                        "üèóÔ∏è **Digital Foundation**: Stabilire infrastrutture digitali di base",
                        "üìä **Data Management**: Implementare sistemi di gestione dati strutturati",
                        "üåê **Digital Presence**: Sviluppare presenza online professionale e e-commerce",
                        "üíº **CRM & ERP Integration**: Sistemi integrati per gestione cliente e risorse",
                        "üìß **Communication Hub**: Centralizzare comunicazioni digitali aziendali",
                        "üéì **Digital Skills**: Programmi di formazione digitale per tutto il team"
                    ];
                }
            }
            
            // Funzione per raccomandazioni tecnologiche
            function getTechRecommendations(overall) {
                const baseRecommendations = [
                    "**Consulenza Strategica**: Assessment dettagliato con roadmap personalizzata",
                    "**Proof of Concept**: Sviluppo pilota per validare soluzioni innovative",
                    "**Change Management**: Supporto nella gestione del cambiamento organizzativo",
                    "**Training Specializzato**: Formazione su tecnologie emergenti per il team"
                ];
                
                if (overall > 70) {
                    return [
                        "üöÄ **Innovation Lab**: Creazione di hub interno per sperimentazione tecnologica",
                        "üéØ **AI Strategy**: Consulenza specifica per implementazione AI aziendale",
                        "üîó **Blockchain Consulting**: Valutazione applicabilit√† e implementazione graduale",
                        ...baseRecommendations
                    ];
                } else if (overall > 50) {
                    return [
                        "‚ö° **Digital Acceleration**: Programma accelerato di trasformazione digitale",
                        "ü§ñ **AI Readiness**: Preparazione infrastrutturale per soluzioni AI",
                        "üìä **Data Strategy**: Consulenza per valorizzazione patrimonio dati",
                        ...baseRecommendations
                    ];
                } else {
                    return [
                        "üéØ **Digital Transformation**: Programma completo di digitalizzazione aziendale",
                        "‚òÅÔ∏è **Cloud Strategy**: Consulenza per migrazione e ottimizzazione cloud",
                        "üìà **Quick Wins**: Identificazione interventi ad alto impatto/basso costo",
                        ...baseRecommendations
                    ];
                }
            }
            
            // Oggetto risultato AI
            const aiSuggestions = {
                strategy_analysis: `L'analisi strategica (${strategyScore}%) per ${companyName} rivela ${strategyScore > 80 ? 'una maturit√† digitale avanzata con forte visione strategica' : strategyScore > 60 ? 'una strategia digitale in evoluzione con potenziale di crescita' : strategyScore > 40 ? 'una base strategica esistente che necessita di rafforzamento' : 'un approccio strategico ancora embrionale che richiede sviluppo strutturato'}. Il mercato attuale richiede approcci data-driven e integrazione di tecnologie emergenti.`,
                
                readiness_analysis: `Il livello di preparazione (${readinessScore}%) indica che ${companyName} ${readinessScore > 80 ? 'possiede infrastrutture digitali mature e pu√≤ implementare soluzioni innovative' : readinessScore > 60 ? 'ha fondamenta digitali solide per evoluzioni tecnologiche mirate' : readinessScore > 40 ? 'necessita di consolidamento infrastrutturale prima di innovazioni avanzate' : 'richiede investimenti significativi in infrastrutture digitali di base'}. L'era dell'Industry 4.0 richiede piattaforme integrate e architetture scalabili.`,
                
                innovation_roadmap: getInnovationRoadmap(overallScore),
                
                technology_recommendations: getTechRecommendations(overallScore),
                
                detailed_assessment_cta: "üìã **RACCOMANDAZIONE PRIORITARIA**: Per un'analisi approfondita e una roadmap personalizzata di trasformazione digitale, consigliamo vivamente di programmare un assessment di dettaglio con i nostri esperti. Questo permetter√† di identificare opportunit√† specifiche, ROI potenziali e implementare soluzioni su misura per il vostro settore."
            };
            
            return aiSuggestions;
        }
        
        function generateInnovationRoadmap(overall, strategy, readiness) {
            if (overall > 80) {
                return [
                    "ü§ñ **Artificial Intelligence Avanzata**: Implementare sistemi di ML per predictive analytics e automazione decisionale",
                    "üîó **Blockchain & Web3**: Esplorare smart contracts per supply chain e trasparenza transazionale", 
                    "üåê **Edge Computing**: Distribuire elaborazione vicino ai dati per latenza ultra-bassa",
                    "ü¶æ **Automazione Intelligente**: RPA integrato con AI per processi complessi end-to-end",
                    "üéØ **Digital Twin**: Modellazione digitale per simulazione e ottimizzazione operativa",
                    "üìä **Advanced Analytics**: Implementare data lakes e real-time business intelligence"
                ];
            } else if (overall > 60) {
                return [
                    "‚òÅÔ∏è **Cloud-First Architecture**: Migrazione completa su architetture cloud native",
                    "ü§ñ **AI Assistants**: Chatbot e automazione processi con intelligenza artificiale",
                    "üì± **API Economy**: Sviluppare ecosistemi integrati tramite API management",
                    "üîê **Cybersecurity Avanzata**: Zero-trust architecture e monitoring predittivo",
                    "üìà **Business Intelligence**: Dashboard real-time e analisi predittive",
                    "üîÑ **DevOps Culture**: CI/CD pipelines e infrastructure as code"
                ];
            } else if (overall > 40) {
                return [
                    "‚òÅÔ∏è **Cloud Migration**: Trasferimento graduale su piattaforme cloud ibride",
                    "üìä **Data Analytics Foundation**: Implementare data warehouse e KPI tracking",
                    "ü§ù **Digital Collaboration**: Piattaforme integrate per remote working",
                    "üì± **Mobile-First Solutions**: App native per processi business critici",
                    "üîí **Security Baseline**: Implementare protocolli di sicurezza moderni",
                    "üîÑ **Process Automation**: Automatizzare task ripetitivi con soluzioni low-code"
                ];
            } else {
                return [
                    "üèóÔ∏è **Digital Foundation**: Stabilire infrastrutture digitali di base",
                    "üìä **Data Management**: Implementare sistemi di gestione dati strutturati",
                    "üåê **Digital Presence**: Sviluppare presenza online professionale e e-commerce",
                    "üíº **CRM & ERP Integration**: Sistemi integrati per gestione cliente e risorse",
                    "üìß **Communication Hub**: Centralizzare comunicazioni digitali aziendali",
                    "üéì **Digital Skills**: Programmi di formazione digitale per tutto il team"
                ];
            }
        }
        
        function getTechnologyRecommendations(overallScore) {
            const baseRecommendations = [
                "**Consulenza Strategica**: Assessment dettagliato con roadmap personalizzata",
                "**Proof of Concept**: Sviluppo pilota per validare soluzioni innovative",
                "**Change Management**: Supporto nella gestione del cambiamento organizzativo",
                "**Training Specializzato**: Formazione su tecnologie emergenti per il team"
            ];
            
            if (overallScore > 70) {
                return [
                    "üöÄ **Innovation Lab**: Creazione di hub interno per sperimentazione tecnologica",
                    "üéØ **AI Strategy**: Consulenza specifica per implementazione AI aziendale",
                    "üîó **Blockchain Consulting**: Valutazione applicabilit√† e implementazione graduale",
                    ...baseRecommendations
                ];
            } else if (overallScore > 50) {
                return [
                    "‚ö° **Digital Acceleration**: Programma accelerato di trasformazione digitale",
                    "ü§ñ **AI Readiness**: Preparazione infrastrutturale per soluzioni AI",
                    "üìä **Data Strategy**: Consulenza per valorizzazione patrimonio dati",
                    ...baseRecommendations
                ];
            } else {
                return [
                    "üéØ **Digital Transformation**: Programma completo di digitalizzazione aziendale",
                    "‚òÅÔ∏è **Cloud Strategy**: Consulenza per migrazione e ottimizzazione cloud",
                    "üìà **Quick Wins**: Identificazione interventi ad alto impatto/basso costo",
                    ...baseRecommendations
                ];
            }
        }

        function showResults(results) {
            document.getElementById('assessmentPanel').classList.add('hidden');
            document.getElementById('resultsPanel').classList.remove('hidden');
            
            // Results content
            const resultsHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4>üéØ Strategia Digitale</h4>
                        <div style="font-size: 2em; font-weight: bold;">${results.strategy_score}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4>üöÄ Preparazione Digitale</h4>
                        <div style="font-size: 2em; font-weight: bold;">${results.readiness_score}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4>üìà Punteggio Totale</h4>
                        <div style="font-size: 2em; font-weight: bold;">${results.overall_score}%</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <h4>üèÜ Livello Maturit√†</h4>
                        <div style="font-size: 1.5em; font-weight: bold; text-transform: capitalize;">${results.maturity_level}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('resultsContent').innerHTML = resultsHTML;
            
            // AI Suggestions
            generateAISuggestions(results).then(aiSuggestions => {
                const aiHTML = `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #0369a1; margin-bottom: 10px;">üìä Analisi Strategica</h5>
                        <p>${aiSuggestions.strategy_analysis}</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #0369a1; margin-bottom: 10px;">üõ†Ô∏è Analisi Preparazione</h5>
                        <p>${aiSuggestions.readiness_analysis}</p>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #0369a1; margin-bottom: 10px;">üöÄ Roadmap Innovazione Digitale</h5>
                        <ul style="padding-left: 20px;">
                            ${aiSuggestions.innovation_roadmap.map(item => `<li style="margin-bottom: 12px;">${item}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: #0369a1; margin-bottom: 10px;">üéØ Raccomandazioni Tecnologiche</h5>
                        <ul style="padding-left: 20px;">
                            ${aiSuggestions.technology_recommendations.map(rec => `<li style="margin-bottom: 10px;">${rec}</li>`).join('')}
                        </ul>
                    </div>
                    <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #92400e; margin-bottom: 10px;">üìã Assessment Dettagliato</h5>
                        <p style="color: #78350f;">${aiSuggestions.detailed_assessment_cta}</p>
                    </div>
                `;
                
                document.getElementById('aiContent').innerHTML = aiHTML;
            });
        }

        // PDF and Email functions (already working)
        async function generatePDF() {
            try {
                document.querySelector('button[onclick="generatePDF()"]').innerHTML = '‚è≥ Generando PDF...';
                document.querySelector('button[onclick="generatePDF()"]').disabled = true;
                
                const response = await fetch('https://intelligence.enduser-digital.com/assessment-extras/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        assessment_data: { 
                            strategy_score: parseInt(document.querySelector('[style*="color: white"] div:nth-child(4)').previousElementSibling.textContent.replace('%', '')) || 88,
                            readiness_score: parseInt(document.querySelectorAll('[style*="color: white"] div')[5]?.textContent.replace('%', '')) || 92,
                            overall_score: parseInt(document.querySelectorAll('[style*="color: white"] div')[9]?.textContent.replace('%', '')) || 90,
                            maturity_level: document.querySelectorAll('[style*="color: white"] div')[13]?.textContent.toLowerCase() || "expert",
                            recommendations: document.getElementById('aiContent')?.textContent || "Assessment completato con suggerimenti AI"
                        },
                        company_info: { 
                            company_name: currentCompany?.name || "Demo Company", 
                            company_sector: currentCompany?.sector || "Technology", 
                            company_id: "web_" + Date.now()
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // Get PDF as blob for download
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Assessment_${currentCompany?.name || 'Demo'}_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // Success message
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 20px; border-radius: 10px; z-index: 10000; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                        <div style="font-weight: bold; margin-bottom: 10px;">‚úÖ PDF Scaricato!</div>
                        <div>Report completo con suggerimenti AI</div>
                        <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: none; border: none; color: white; font-size: 18px; cursor: pointer;">√ó</button>
                    </div>
                `;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 5000);
                
            } catch (error) {
                console.error('PDF Error:', error);
                alert('‚ùå Errore generazione PDF: ' + error.message);
            } finally {
                document.querySelector('button[onclick="generatePDF()"]').innerHTML = 'üìÑ Genera PDF';
                document.querySelector('button[onclick="generatePDF()"]').disabled = false;
            }
        }

        async function sendEmail() {
            const email = prompt('üìß Email destinatario:', 'stefano@enduser-digital.com');
            if (!email) return;
            
            try {
                const response = await fetch('https://intelligence.enduser-digital.com/assessment-extras/send-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_email: email,
                        company_name: currentCompany?.name || "Demo Company",
                        assessment_data: { 
                            strategy_score: 88, 
                            readiness_score: 92, 
                            overall_score: 90, 
                            maturity_level: "expert",
                            recommendations: "Eccellente livello digitale raggiunto!"
                        },
                        company_info: { 
                            company_name: currentCompany?.name || "Demo Company", 
                            company_sector: currentCompany?.sector || "Technology", 
                            company_id: "web_email_" + Date.now()
                        },
                        include_pdf: true
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('‚úÖ Email inviata a: ' + email + '\nPDF allegato: ' + (result.pdf_size/1024).toFixed(1) + ' KB');
                } else {
                    alert('‚ùå Errore Email: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }

        function newAssessment() {
            document.getElementById('resultsPanel').classList.add('hidden');
            document.getElementById('companySelection').classList.remove('hidden');
            
            // Reset
            currentCompany = null;
            selectedCompanyData = null;
            responses = {};
            currentSectionIndex = 0;
            
            document.getElementById('companySearch').value = '';
            document.getElementById('newCompanyName').value = '';
            document.getElementById('sectorSelect').value = '';
            document.getElementById('companyInfo').classList.add('hidden');
        }

        // Initialize
        window.addEventListener('load', function() {
            loadCompanies();
            setupCompanySearch();
        });
    </script>
</body>
</html>