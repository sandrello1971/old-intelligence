from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session, joinedload
from app.core.database import get_db
from app.models.ticket import Ticket
from app.models.task import Task
from app.models.activity import Activity
from app.models.opportunity import Opportunity
from app.models.milestone import Milestone
from app.models.phase_template import PhaseTemplate

router = APIRouter(prefix="/treeview", tags=["treeview"])

@router.get("/companies")
def get_company_tree(db: Session = Depends(get_db)):
    tickets = db.query(Ticket).options(
        joinedload(Ticket.tasks),
        joinedload(Ticket.activity),
        joinedload(Ticket.company),
        joinedload(Ticket.milestone),
    ).all()

    # ✅ ORDINAMENTO TASK DA CONFIGURAZIONE ADMIN
    task_order_map = {
        pt.description: pt.order for pt in db.query(PhaseTemplate).all()
    }

    companies = {}

    for ticket in tickets:
        customer_name = (
            ticket.customer_name or
            (ticket.company.nome if ticket.company else None) or
            "(Sconosciuto)"
        )

        if customer_name not in companies:
            companies[customer_name] = {
                "name": customer_name,
                "commessa": None,
                "opportunities": []
            }

            crm_opps = db.query(Opportunity).filter(Opportunity.cliente == customer_name).all()
            for opp in crm_opps:
                has_activities = db.query(Activity).filter(Activity.opportunity_id == str(opp.id)).count() > 0
                companies[customer_name]["opportunities"].append({
                    "opportunity_code": opp.codice,
                    "title": opp.titolo,
                    "id": opp.id,
                    "has_activities": has_activities,
                    "tickets": []
                })

                   ticket_data = {
            "id": ticket.id,
            "ticket_code": ticket.ticket_code,
            "title": ticket.title,
            "customer_name": customer_name,
            "gtd_generated": ticket.gtd_generated,
            "milestone": {
                "id": ticket.milestone.id if ticket.milestone else None,
                "name": ticket.milestone.name if ticket.milestone else None
            } if ticket.milestone else None,
            "activity": {
                "id": ticket.activity.id if ticket.activity else None,
                "description": ticket.activity.description if ticket.activity else None,
            },
            "tasks": sorted([
                {
                    "id": task.id,
                    "title": task.title,
                    "status": task.status,
                    "order": task_order_map.get(task.title, 0)
                }
                for task in ticket.tasks
            ], key=lambda x: x["order"])
        }

        # Collega il ticket alla relativa opportunità
        for opp in companies[customer_name]["opportunities"]:
            if opp["opportunity_code"] == (ticket.activity.opportunity.codice if ticket.activity and ticket.activity.opportunity else None):
                opp["tickets"].append(ticket_data)
                break

