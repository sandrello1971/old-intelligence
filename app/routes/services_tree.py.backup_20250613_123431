from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from app.core.database import get_db
from app.models.sub_type import SubType
from app.models.milestone import Milestone  
from app.models.phase_template import PhaseTemplate
from app.models.service_user_association import ServiceUserAssociation
from app.models.user import User
from typing import List, Dict, Any, Optional
from pydantic import BaseModel
import logging

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/services-tree", tags=["Services Tree"])

class MilestoneCreate(BaseModel):
    name: str
    order: int
    sla_days: Optional[int] = 5
    warning_days: Optional[int] = 2
    escalation_days: Optional[int] = 3

class TaskTemplateCreate(BaseModel):
    code: str
    type: str
    description: str
    order: Optional[int] = 1

@router.get("/")
async def get_services_tree(db: Session = Depends(get_db)):
    """Restituisce l'alberatura completa dei servizi CON UTENTI"""
    try:
        services = db.query(SubType).all()
        result = []
        
        for service in services:
            # AGGIUNGO SOLO GLI UTENTI ASSEGNATI
            user_assignments = db.query(ServiceUserAssociation).filter(
                ServiceUserAssociation.service_id == service.id
            ).all()
            
            assigned_users = []
            for assignment in user_assignments:
                user = db.query(User).filter(User.id == assignment.user_id).first()
                if user:
                    assigned_users.append({
                        "user_id": assignment.user_id,
                        "email": user.email,
                        "display_name": f"{user.name} {user.surname}".strip(),
                        "role": assignment.role
                    })
            
            milestones = db.query(Milestone).filter(
                Milestone.project_type == service.code
            ).order_by(Milestone.order).all()
            
            milestones_data = []
            for milestone in milestones:
                task_templates = db.query(PhaseTemplate).filter(
                    PhaseTemplate.milestone_id == milestone.id
                ).order_by(PhaseTemplate.order).all()
                
                milestone_data = {
                    "id": milestone.id,
                    "name": milestone.name,
                    "order": milestone.order,
                    "project_type": milestone.project_type,
                    "sla_days": 5,
                    "warning_days": 2, 
                    "escalation_days": 3,
                    "task_templates": [
                        {
                            "id": template.id,
                            "code": template.code,
                            "type": template.type,
                            "description": template.description,
                            "order": getattr(template, 'order', 0),
                            "parent_id": getattr(template, 'parent_id', None)
                        }
                        for template in task_templates
                    ]
                }
                milestones_data.append(milestone_data)
            
            service_data = {
                "id": service.id,
                "name": service.name,
                "code": service.code,
                "description": getattr(service, 'description', ''),
                "active": getattr(service, 'active', True),
                "assigned_users": assigned_users,  # ← AGGIUNTO UTENTI
                "milestones": milestones_data
            }
            result.append(service_data)
        
        logger.info(f"✅ Caricati {len(result)} servizi con utenti")
        return result
        
    except Exception as e:
        logger.error(f"❌ Errore: {e}")
        return []

@router.get("/users")
async def get_users(db: Session = Depends(get_db)):
    """Lista utenti disponibili"""
    try:
        users = db.query(User).all()
        return [
            {
                "id": user.id,
                "email": user.email,
                "display_name": f"{user.name} {user.surname}".strip(),
                "role": "user"
            }
            for user in users
        ]
    except Exception as e:
        logger.error(f"❌ Errore users: {e}")
        return []

@router.get("/health")
async def health_check():
    """Health check"""
    return {
        "status": "ok", 
        "message": "Services Tree con utenti - BASE FUNZIONANTE",
        "endpoints": [
            "GET / - Lista servizi con utenti",
            "GET /users - Lista utenti"
        ]
    }
