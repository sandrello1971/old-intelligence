<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† Digital Maturity Assessment v4.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: #333;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .card { 
            background: white; border-radius: 15px; padding: 30px; margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
        .form-group { display: flex; flex-direction: column; }
        .form-input { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin-top: 5px; }
        .form-label { font-weight: 600; color: #374151; margin-bottom: 5px; }
        .btn { 
            background: #4F46E5; color: white; border: none; padding: 15px 30px; 
            border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
        }
        .btn:hover { background: #3730A3; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .search-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .search-results { max-height: 300px; overflow-y: auto; background: white; border-radius: 8px; }
        .company-item { padding: 15px; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .company-item:hover { background: #f3f4f6; }
        .company-item:last-child { border-bottom: none; }
        
        #company-form, #assessment-form { display: none; }
        .required { color: #dc2626; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Digital Maturity Assessment v4.0</h1>
            <p>Intelligence Platform - Valutazione Maturit√† Digitale Aziendale</p>
            <p style="font-size: 14px; opacity: 0.9;">Assessment completo con raccolta dati azienda</p>
        </div>

        <!-- STEP 1: RICERCA/CREAZIONE AZIENDA -->
        <div class="card" id="company-search">
            <h2>üè¢ Dati Azienda</h2>
            
            <div class="search-section">
                <h3>üîç Cerca Azienda Esistente</h3>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <input type="text" id="search-input" class="form-input" placeholder="Cerca per ragione sociale o partita IVA..." style="flex: 1;">
                    <button class="btn" onclick="searchCompanies()">Cerca</button>
                </div>
                <div id="search-results" class="search-results" style="display: none; margin-top: 15px;"></div>
            </div>
            
            <div style="text-align: center; margin: 20px 0; color: #6b7280;">
                <strong>OPPURE</strong>
            </div>
            
            <button class="btn" onclick="showCompanyForm()" style="width: 100%;">
                ‚ûï Inserisci Nuova Azienda
            </button>
        </div>

        <!-- STEP 2: FORM NUOVA AZIENDA -->
        <div class="card" id="company-form">
            <h2>üìã Inserimento Dati Azienda</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Ragione Sociale <span class="required">*</span></label>
                    <input type="text" id="ragione-sociale" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Partita IVA <span class="required">*</span></label>
                    <input type="text" id="partita-iva" class="form-input" required maxlength="11">
                </div>
                <div class="form-group">
                    <label class="form-label">Settore</label>
                    <select id="settore" class="form-input">
                        <option value="">Seleziona settore</option>
                        <option value="tecnologia">Tecnologia</option>
                        <option value="manifatturiero">Manifatturiero</option>
                        <option value="servizi">Servizi</option>
                        <option value="commercio">Commercio</option>
                        <option value="costruzioni">Costruzioni</option>
                        <option value="sanita">Sanit√†</option>
                        <option value="consulenza">Consulenza</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Dimensione Aziendale</label>
                    <select id="dimensione" class="form-input">
                        <option value="">Seleziona dimensione</option>
                        <option value="micro">Micro (1-9 dipendenti)</option>
                        <option value="piccola">Piccola (10-49 dipendenti)</option>
                        <option value="media">Media (50-249 dipendenti)</option>
                        <option value="grande">Grande (250+ dipendenti)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Numero Dipendenti</label>
                    <input type="number" id="dipendenti" class="form-input" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Fatturato Annuo</label>
                    <select id="fatturato" class="form-input">
                        <option value="">Seleziona range</option>
                        <option value="0-100k">0 - 100k ‚Ç¨</option>
                        <option value="100k-500k">100k - 500k ‚Ç¨</option>
                        <option value="500k-2M">500k - 2M ‚Ç¨</option>
                        <option value="2M-10M">2M - 10M ‚Ç¨</option>
                        <option value="10M+">10M+ ‚Ç¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Provincia</label>
                    <input type="text" id="provincia" class="form-input" maxlength="2" placeholder="es. BO">
                </div>
                <div class="form-group">
                    <label class="form-label">Regione</label>
                    <input type="text" id="regione" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Sito Web</label>
                    <input type="url" id="sito-web" class="form-input" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Contatto</label>
                    <input type="email" id="email" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Telefono</label>
                    <input type="tel" id="telefono" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Note</label>
                    <textarea id="note" class="form-input" rows="3"></textarea>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-secondary" onclick="backToSearch()">‚Üê Indietro</button>
                <button class="btn" onclick="saveCompanyAndStart()" style="flex: 1;">üíæ Salva Azienda e Inizia Assessment</button>
            </div>
        </div>

        <!-- STEP 3: ASSESSMENT (placeholder) -->
        <div class="card" id="assessment-form">
            <h2>üìä Assessment in corso...</h2>
            <p>Assessment con 88 domande verr√† caricato qui...</p>
            <button class="btn" onclick="alert('Assessment implementazione in corso')">üöÄ Continua Assessment</button>
        </div>
    </div>

    <script>
        const API_BASE = '/api/assessment/v2';
        let selectedCompany = null;

        async function searchCompanies() {
            const query = document.getElementById('search-input').value;
            if (!query || query.length < 2) {
                alert('Inserisci almeno 2 caratteri per la ricerca');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/companies?search=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const resultsDiv = document.getElementById('search-results');
                
                if (data.companies && data.companies.length > 0) {
                    resultsDiv.innerHTML = data.companies.map(company => `
                        <div class="company-item" onclick="selectExistingCompany(${company.id}, '${company.ragione_sociale}', '${company.partita_iva}')">
                            <strong>${company.ragione_sociale}</strong><br>
                            <small>P.IVA: ${company.partita_iva} ‚Ä¢ ${company.settore || 'Settore non specificato'} ‚Ä¢ ${company.numero_dipendenti || '?'} dipendenti</small>
                        </div>
                    `).join('');
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="company-item">Nessuna azienda trovata. Clicca "Inserisci Nuova Azienda" per aggiungerla.</div>';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                alert('Errore ricerca: ' + error.message);
            }
        }

        function selectExistingCompany(id, ragioneSociale, partitaIva) {
            selectedCompany = { id, ragione_sociale: ragioneSociale, partita_iva: partitaIva };
            if (confirm(`Vuoi iniziare l'assessment per "${ragioneSociale}"?`)) {
                startAssessment();
            }
        }

        function showCompanyForm() {
            document.getElementById('company-search').style.display = 'none';
            document.getElementById('company-form').style.display = 'block';
        }

        function backToSearch() {
            document.getElementById('company-form').style.display = 'none';
            document.getElementById('company-search').style.display = 'block';
        }

        async function saveCompanyAndStart() {
            const ragioneSociale = document.getElementById('ragione-sociale').value;
            const partitaIva = document.getElementById('partita-iva').value;
            
            if (!ragioneSociale || !partitaIva) {
                alert('Ragione sociale e partita IVA sono obbligatori');
                return;
            }

            const companyData = {
                ragione_sociale: ragioneSociale,
                partita_iva: partitaIva,
                settore: document.getElementById('settore').value,
                dimensione_aziendale: document.getElementById('dimensione').value,
                numero_dipendenti: parseInt(document.getElementById('dipendenti').value) || null,
                fatturato_annuo: document.getElementById('fatturato').value,
                provincia: document.getElementById('provincia').value,
                regione: document.getElementById('regione').value,
                sito_web: document.getElementById('sito-web').value,
                email_contatto: document.getElementById('email').value,
                telefono: document.getElementById('telefono').value,
                note: document.getElementById('note').value
            };

            try {
                const response = await fetch(`${API_BASE}/companies`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(companyData)
                });

                const result = await response.json();
                
                if (result.success) {
                    selectedCompany = { 
                        id: result.company_id, 
                        ragione_sociale: ragioneSociale, 
                        partita_iva: partitaIva 
                    };
                    alert('‚úÖ Azienda salvata con successo!');
                    startAssessment();
                } else {
                    alert('‚ùå Errore salvataggio: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Errore: ' + error.message);
            }
        }

        function startAssessment() {
            document.getElementById('company-form').style.display = 'none';
            document.getElementById('company-search').style.display = 'none';
            document.getElementById('assessment-form').style.display = 'block';
            
            // QUI ANDR√Ä IL CARICAMENTO DELLE 88 DOMANDE
            console.log('üöÄ Inizio assessment per:', selectedCompany);
        }

        // Validazione partita IVA
        document.getElementById('partita-iva').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        window.onload = () => {
            console.log('üß† Assessment v4.0 - Company Form Ready');
        };
    </script>
</body>
</html>
